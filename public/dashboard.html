<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BusBook Travel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="busbook.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-bus"></i>
                <span>BusBook</span>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Home</a>
                <a href="/#routes" class="nav-link">Routes</a>
                <a href="/#about" class="nav-link">About</a>
                <a href="/#contact" class="nav-link">Contact</a>
                <div class="nav-auth">
                    <span id="userGreeting" style="margin-right: 1rem; color: #64748b;"></span>
                    <button onclick="logout()" class="btn btn-outline">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard -->
    <div class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>Welcome to Your Dashboard</h1>
                <p>Manage your bookings and travel preferences</p>
            </div>

            <div class="dashboard-nav">
                <button class="dashboard-tab active" data-tab="bookings">My Bookings</button>
                <button class="dashboard-tab" data-tab="new-booking">New Booking</button>
                <button class="dashboard-tab" data-tab="profile">Profile</button>
                <button class="dashboard-tab" data-tab="payment">Payment Methods</button>
                <button class="dashboard-tab hidden" data-tab="admin" id="adminTab">Admin Panel</button>
            </div>

            <!-- Bookings Tab -->
            <div id="bookings" class="dashboard-content">
                <h2>My Bookings</h2>
                <div id="bookingsList">
                    <!-- Bookings will be loaded here -->
                </div>
            </div>

            <!-- New Booking Tab -->
            <div id="new-booking" class="dashboard-content" style="display: none;">
                <h2>Book a New Trip</h2>
                <form id="bookingForm" style="max-width: 600px;">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>From</label>
                            <select id="fromCity" required>
                                <option value="">Select departure city</option>
                                <option value="New York">New York</option>
                                <option value="Boston">Boston</option>
                                <option value="Philadelphia">Philadelphia</option>
                                <option value="Washington DC">Washington DC</option>
                                <option value="Los Angeles">Los Angeles</option>
                                <option value="San Francisco">San Francisco</option>
                                <option value="Chicago">Chicago</option>
                                <option value="Detroit">Detroit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>To</label>
                            <select id="toCity" required>
                                <option value="">Select destination city</option>
                                <option value="New York">New York</option>
                                <option value="Boston">Boston</option>
                                <option value="Philadelphia">Philadelphia</option>
                                <option value="Washington DC">Washington DC</option>
                                <option value="Los Angeles">Los Angeles</option>
                                <option value="San Francisco">San Francisco</option>
                                <option value="Chicago">Chicago</option>
                                <option value="Detroit">Detroit</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Departure Date</label>
                            <input type="date" id="departureDate" required>
                        </div>
                        <div class="form-group">
                            <label>Passengers</label>
                            <select id="passengers">
                                <option value="1">1 Passenger</option>
                                <option value="2">2 Passengers</option>
                                <option value="3">3 Passengers</option>
                                <option value="4">4 Passengers</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem;">Payment Information</h3>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Card Number</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                        </div>
                        <div class="form-group">
                            <label>Cardholder Name</label>
                            <input type="text" id="cardName" placeholder="John Doe" required>
                        </div>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="text" id="expiryDate" placeholder="MM/YY" required>
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" id="cvv" placeholder="123" required>
                        </div>
                        <div class="form-group">
                            <label>Total Price</label>
                            <input type="text" id="totalPrice" value="$89.99" readonly style="background: #f8fafc;">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-credit-card"></i>
                        Book Now - $89.99
                    </button>
                </form>
            </div>

            <!-- Profile Tab -->
            <div id="profile" class="dashboard-content" style="display: none;">
                <h2>Profile Information</h2>
                <div id="profileInfo">
                    <!-- Profile info will be loaded here -->
                </div>
            </div>

            <!-- Payment Methods Tab -->
            <div id="payment" class="dashboard-content" style="display: none;">
                <h2>Saved Payment Methods</h2>
                <div id="paymentMethods">
                    <!-- Payment methods will be loaded here -->
                </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="admin" class="dashboard-content" style="display: none;">
                <h2>Admin Panel</h2>
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalBookings">0</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalRevenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeRoutes">0</div>
                        <div class="stat-label">Active Routes</div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div style="margin-top: 2rem; background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem;">
                    <h3>User Management</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                        <!-- Add New User -->
                        <div>
                            <h4>Add New User</h4>
                            <form id="addUserForm">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Full Name</label>
                                    <input type="text" id="newUserName" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Email</label>
                                    <input type="email" id="newUserEmail" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Password</label>
                                    <input type="password" id="newUserPassword" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Phone</label>
                                    <input type="tel" id="newUserPhone">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Role</label>
                                    <select id="newUserRole">
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                        <option value="manager">Manager</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Add User</button>
                            </form>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div>
                            <h4>Quick Actions</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button onclick="refreshAdminData()" class="btn btn-outline">Refresh Data</button>
                                <button onclick="exportUserData()" class="btn btn-outline">Export Users</button>
                                <button onclick="showSystemInfo()" class="btn btn-outline">System Info</button>
                            </div>
                            
                            <div id="systemInfo" style="margin-top: 1rem; display: none; background: #fff; padding: 1rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                <h5>System Information</h5>
                                <p><strong>Database:</strong> MongoDB Atlas</p>
                                <p><strong>Status:</strong> <span style="color: #10b981;">Connected</span></p>
                                <p><strong>Security:</strong> <span style="color: #ef4444;">⚠️ Vulnerabilities Present</span></p>
                                <p><strong>Auth:</strong> <span style="color: #ef4444;">No Role Validation</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>All Users</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Role</th>
                                <th>Credit Card</th>
                                <th>Date Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>All Bookings</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>User</th>
                                <th>Route</th>
                                <th>Date</th>
                                <th>Passengers</th>
                                <th>Price</th>
                                <th>Card Number</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminBookingsTable">
                            <!-- Bookings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Load user session on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSession();
            loadDashboardData();
        });

        async function checkSession() {
            try {
                const response = await fetch('/api/session');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.fullName}`;
                    
                    // IMPORTANT: Only show admin tab if user is ACTUALLY admin or manager
                    // Regular users should NOT see this tab at all
                    if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                        document.getElementById('adminTab').classList.remove('hidden');
                    } else {
                        // Hide admin tab for regular users
                        document.getElementById('adminTab').classList.add('hidden');
                    }
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Session check failed:', error);
                window.location.href = '/login';
            }
        }

        // Tab switching functionality
        document.querySelectorAll('.dashboard-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.dashboard-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabName).style.display = 'block';

            // Load tab-specific data
            if (tabName === 'admin') {
                loadAdminData();
            } else if (tabName === 'profile') {
                loadProfileData();
            } else if (tabName === 'payment') {
                loadPaymentMethods();
            }
        }

        async function loadDashboardData() {
            await loadBookings();
            setMinDate();
        }

        async function loadBookings() {
            try {
                const response = await fetch('/api/bookings');
                const bookings = await response.json();
                
                const bookingsList = document.getElementById('bookingsList');
                if (bookings.length === 0) {
                    bookingsList.innerHTML = '<p style="color: #64748b;">No bookings found. <a href="#" onclick="switchTab(\'new-booking\')">Book your first trip!</a></p>';
                    return;
                }
                
                bookingsList.innerHTML = bookings.map(booking => `
                    <div class="booking-card">
                        <div class="booking-header">
                            <span class="booking-id">Booking #${booking.id}</span>
                            <span class="booking-status status-${booking.status}">${booking.status}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div>
                                <strong>Route:</strong> ${booking.fromCity} → ${booking.toCity}
                            </div>
                            <div>
                                <strong>Date:</strong> ${new Date(booking.departureDate).toLocaleDateString()}
                            </div>
                            <div>
                                <strong>Passengers:</strong> ${booking.passengers}
                            </div>
                            <div>
                                <strong>Price:</strong> $${booking.totalPrice}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load bookings:', error);
            }
        }

        async function loadAdminData() {
            try {
                const [usersResponse, bookingsResponse, statsResponse] = await Promise.all([
                    fetch('/api/admin/users'),
                    fetch('/api/admin/bookings'),
                    fetch('/api/admin/stats')
                ]);

                const users = await usersResponse.json();
                const bookings = await bookingsResponse.json();
                const stats = await statsResponse.json();

                // Update stats
                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('totalBookings').textContent = stats.totalBookings;
                document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue}`;
                document.getElementById('activeRoutes').textContent = stats.activeRoutes;

                // Update users table
                const usersTable = document.getElementById('usersTable');
                usersTable.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.fullName}</td>
                        <td>${user.email}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>
                            <select onchange="changeUserRole('${user.id}', this.value)" ${user.id === currentUser.id ? 'disabled' : ''}>
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                            </select>
                        </td>
                        <td>${user.creditCard || 'N/A'}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            ${user.id !== currentUser.id ? 
                                `<button onclick="deleteUser('${user.id}', '${user.fullName}')" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Delete</button>` : 
                                '<span style="color: #9ca3af;">Current User</span>'
                            }
                        </td>
                    </tr>
                `).join('');

                // Update bookings table
                const adminBookingsTable = document.getElementById('adminBookingsTable');
                adminBookingsTable.innerHTML = bookings.map(booking => `
                    <tr>
                        <td>#${booking.id}</td>
                        <td>${booking.userName}</td>
                        <td>${booking.fromCity} → ${booking.toCity}</td>
                        <td>${new Date(booking.departureDate).toLocaleDateString()}</td>
                        <td>${booking.passengers}</td>
                        <td>$${booking.totalPrice}</td>
                        <td>${booking.cardNumber || 'N/A'}</td>
                        <td><span class="booking-status status-${booking.status}">${booking.status}</span></td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Failed to load admin data:', error);
            }
        }

        async function loadProfileData() {
            const profileInfo = document.getElementById('profileInfo');
            profileInfo.innerHTML = `
                <div style="max-width: 500px;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" class="form-control" value="${currentUser.fullName}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" value="${currentUser.email}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" class="form-control" value="${currentUser.phone || 'Not provided'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Account Type</label>
                        <input type="text" class="form-control" value="${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Member Since</label>
                        <input type="text" class="form-control" value="${new Date(currentUser.createdAt).toLocaleDateString()}" readonly>
                    </div>
                </div>
            `;
        }

        async function loadPaymentMethods() {
            const paymentMethods = document.getElementById('paymentMethods');
            paymentMethods.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i>
                    For security reasons, we don't store complete credit card information. Payment details are processed securely during each transaction.
                </div>
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1rem;">
                    <h4>Security Notice</h4>
                    <p>All payment information is encrypted and processed through our secure payment gateway. We never store your complete credit card details on our servers.</p>
                </div>
            `;
        }

        // Booking form submission
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const bookingData = {
                fromCity: formData.get('fromCity') || document.getElementById('fromCity').value,
                toCity: formData.get('toCity') || document.getElementById('toCity').value,
                departureDate: formData.get('departureDate') || document.getElementById('departureDate').value,
                passengers: formData.get('passengers') || document.getElementById('passengers').value,
                cardNumber: formData.get('cardNumber') || document.getElementById('cardNumber').value,
                cardName: formData.get('cardName') || document.getElementById('cardName').value,
                expiryDate: formData.get('expiryDate') || document.getElementById('expiryDate').value,
                cvv: formData.get('cvv') || document.getElementById('cvv').value,
                totalPrice: '89.99'
            };
            
            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });
                
                if (response.ok) {
                    alert('Booking created successfully!');
                    document.getElementById('bookingForm').reset();
                    switchTab('bookings');
                    loadBookings();
                } else {
                    const error = await response.json();
                    alert('Booking failed: ' + error.error);
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        });

        function setMinDate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('departureDate').min = tomorrow.toISOString().split('T')[0];
        }

        // Format card number input
        document.getElementById('cardNumber').addEventListener('input', function() {
            let value = this.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            this.value = formattedValue;
        });

        // Format expiry date input
        document.getElementById('expiryDate').addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            this.value = value;
        });

        // CVV input restriction
        document.getElementById('cvv').addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 4);
        });

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        // Admin user management functions
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                fullName: document.getElementById('newUserName').value,
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPassword').value,
                phone: document.getElementById('newUserPhone').value,
                role: document.getElementById('newUserRole').value
            };
            
            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    alert('User created successfully!');
                    document.getElementById('addUserForm').reset();
                    loadAdminData(); // Refresh the data
                } else {
                    const error = await response.json();
                    alert('Failed to create user: ' + error.error);
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        });

        async function changeUserRole(userId, newRole) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });
                
                if (response.ok) {
                    alert('User role updated successfully!');
                    loadAdminData(); // Refresh the data
                } else {
                    const error = await response.json();
                    alert('Failed to update role: ' + error.error);
                    loadAdminData(); // Refresh to revert the dropdown
                }
            } catch (error) {
                alert('Network error. Please try again.');
                loadAdminData(); // Refresh to revert the dropdown
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('User deleted successfully!');
                    loadAdminData(); // Refresh the data
                } else {
                    const error = await response.json();
                    alert('Failed to delete user: ' + error.error);
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        function refreshAdminData() {
            loadAdminData();
            alert('Admin data refreshed!');
        }

        function exportUserData() {
            // This would normally export data, but for demo purposes, just show alert
            alert('User data export feature - This would normally download a CSV file with all user data (including passwords in plain text due to vulnerability).');
        }

        function showSystemInfo() {
            const systemInfo = document.getElementById('systemInfo');
            systemInfo.style.display = systemInfo.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
